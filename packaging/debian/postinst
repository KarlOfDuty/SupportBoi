#!/bin/sh
# postinst script for supportboi.
#
# See: dh_installdeb(1).

set -e

# Summary of how this script can be called:
#        * <postinst> 'configure' <most-recently-configured-version>
#        * <old-postinst> 'abort-upgrade' <new version>
#        * <conflictor's-postinst> 'abort-remove' 'in-favour' <package>
#          <new-version>
#        * <postinst> 'abort-remove'
#        * <deconfigured's-postinst> 'abort-deconfigure' 'in-favour'
#          <failed-install-package> <version> 'removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package.


case "$1" in
  configure)
    getent group supportboi > /dev/null || groupadd supportboi
    getent passwd supportboi > /dev/null || useradd -r -m -d /var/lib/supportboi -s /sbin/nologin -g supportboi supportboi
    chmod 400 /etc/supportboi/config.yml
    chmod 555 /usr/bin/supportboi
    chown supportboi:supportboi /etc/supportboi/config.yml
    chown supportboi:supportboi /usr/bin/supportboi
    install -m 700 -o supportboi -g supportboi -d /var/lib/supportboi
    install -m 755 -o supportboi -g supportboi -d /var/lib/supportboi/transcripts
    install -m 755 -o supportboi -g supportboi -d /var/logs/supportboi

    SYSTEMD_VERSION=$(systemctl --version | awk '{if($1=="systemd" && $2~"^[0-9]"){print $2}}' | head -n 1)
    if (( $SYSTEMD_VERSION < 253 )); then
        echo "Systemd version is lower than 253 ($SYSTEMD_VERSION); using legacy service type 'notify' instead of 'notify-reload'"
        sed -i 's/^Type=notify-reload$/Type=notify/' "/usr/lib/systemd/system/supportboi.service"
    fi

    systemctl daemon-reload
    if [ -f "/tmp/.supportboi-upgrade-stopped-service" ]; then
      systemctl start supportboi.service
      rm "/tmp/.supportboi-upgrade-stopped-service"
    fi
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    systemctl daemon-reload
  ;;

  *)
    echo "postinst called with unknown argument '$1'" >&2
    exit 1
  ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
